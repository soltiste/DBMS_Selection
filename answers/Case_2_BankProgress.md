Аналитический отдел банка жалуется, что создание ежемесячных отчетов по продажам финансовых продуктов по всем филиалам занимает более 20 часов и полностью нагружает основную систему, мешая операционной работе.  

**Требования:**  
- быстрое выполнение сложных агрегирующих запросов (суммы, средние, рост по регионам);  
- работа с историческими данными за 10 лет;  
- разгрузка основной операционной системы.  

---

## ❓ Вопросы для ответа

### 1. Какие ключевые требования к СУБД в этом кейсе? 
1) СУБД должна поддреживать быстрое выполнение агрегирующих запросов;
2) Поддержка работы с большим объемом данных (10 лет) и дальнейшего его увеличения;
3) В аналитике банка часто будут требоваться запросы к конкретным периодам - нужна СУБД, поддерживающая партиционирование и временные таблицы;
4) Не ясно, почему нет разделения между основной системой хранения и аналитической системой для формирования отчетов. И это как раз та архитектурная ошибка, которую мы должны исправить - четко определить зоны ответственности;
5) Было бы здорово, чтобы у СУБД сразу был BI-инструмент, легко согласующийся с ней;
6) Поддержка шифрования данных и резервного копирования для снижения репутационных рисков;

Все соображения и выводы из этого пункта построены на информации, полученной при погружении и решении кейса для ПСПб от работников. К сожалению, не могу восстановить источники, но могу попытаться найти задания.

### 2. Какие сложности или ограничения могут возникнуть при выборе СУБД? 
1) Осведомленность персонала (например, меня) о СУБД: переход к новой или оптимизация старой - вызов для персонала. Потребуется время, прежде чем мы сможем обучить работников или нанять новых и приступить к интеграции;
2) Так как мы работаем с историческими данными, данными разных филиалов, различных продуктов, налаживаем взаимодействие между OLTP и OLAP, нам потребуется глобальная настройка ETL-процессов с нуля, что приводит к риску возникновения технических ошибок, потери данных и связанных с ними финансовых и репутационных рисков;
3) Высокая стоимость разработки и поддержки наиболее оптимальной системы ведет к риску неудовлетворения запроса заказчика и требует дополнительных ресурсов для корректной оценки каждого из вариантов решения.

### 3. Какие классы СУБД подходят для решения задачи?  
Для новой аналитической системы:
1) OLAP;
2) Колоночная.

Для существующей системы я бы рассмотрела, какие расширения в сторону оптимизации запросов появились за последнее время и успели зарекомендовать себя.

### 4. Приведите примеры конкретных СУБД, которые вы бы выбрали.  
### 5. Обоснуйте ваш выбор: почему именно эта СУБД?  
Для переработки текста ответа использовала Qwen3-Max с предварительным разговором о кейсе и требованиях.

ClickHouse
Я бы выбрала ClickHouse в качестве приоритетного решения по следующим причинам:
1) Высокая производительность: архитектура с колоночным хранением, векторизованные вычисления и эффективное сжатие данных позволяют обрабатывать сложные запросы (SUM, AVG, темпы роста по регионам) на десятках миллиардов строк за секунды — что напрямую решает проблему 20-часовых отчётов.
2) Экономичность хранения: поддержка работы с HDD (в отличие от многих in-memory OLAP-систем) снижает TCO, особенно при хранении 10+ лет исторических данных.
3) Гибкость моделирования: поддержка партиционирования по дате, TTL для автоматического архивирования, материализованных представлений и временных таблиц упрощает построение слоя аналитики.
4) Интеграция с BI: ClickHouse имеет драйверы для всех популярных BI-инструментов (Tableau, Power BI, Superset), что ускоряет развёртывание отчётности.
5) ClickHouse не заменяет OLTP: он работает как отдельное аналитическое хранилище, куда данные поступают через ETL/ELT из основной системы. Это полностью разгружает операционную БД.
6) Мой практический опыт и знания: я знаю, что ПСПб успешно использует ClickHouse для подобных задач, что подтверждает его применимость в регулируемой банковской среде.


Greenplum
Если основная OLTP-система построена на PostgreSQL, Greenplum становится логичной альтернативой:
1) Совместимость с экосистемой PostgreSQL: SQL-диалект, расширения, инструменты администрирования — всё знакомо команде, что снижает порог входа и риски ошибок.
2) Массовый параллелизм (MPP): Greenplum распределяет аналитические запросы по сегментам, обеспечивая масштабируемость на больших объёмах данных.
3) Поддержка enterprise-требований: встроенные механизмы репликации, резервного копирования, ролевой безопасности и аудита — критически важны для банков.
4) Гибридный подход: можно начать с небольшого кластера и масштабировать по мере роста нагрузки.
5) Недостатки: Однако стоит учитывать, что Greenplum требует больше ресурсов (в первую очередь RAM и SSD) и сложнее в настройке партиционирования по сравнению с ClickHouse.

### 6. Какие риски или проблемы могут возникнуть при эксплуатации выбранной СУБД?  
ClickHouse:
1) Сложность обработки изменений (UPDATE/DELETE): ClickHouse изначально проектировался для append-only сценариев. Операции ALTER UPDATE и ALTER DELETE — это тяжёлые фоновые процессы, которые переписывают целые партиции. В банковской аналитике, где могут потребоваться корректировки (например, отмена продажи), это создаёт задержки и усложняет ETL-логику.
2) Зависимость от качества модели данных: Производительность напрямую зависит от правильного выбора ключей сортировки и партиционирования. Ошибка на этапе проектирования может свести на нет все преимущества скорости.
3) Ограниченная поддержка enterprise-функций «из коробки»: Нет встроенной ролевой модели с тонкой настройкой прав доступа, сложности с аудитом запросов(по умолчанию не ведётся подробный журнал того, кто, когда и какие данные запрашивал), отсутствие native-поддержки материализованных представлений с зависимостями (в отличие от Greenplum). Это усложняет соответствие требованиям ЦБ РФ по аудиту и разграничению доступа.

2. Greenplum
1) Сложность администрирования MPP-кластера: Greenplum — это распределённая MPP-система на базе PostgreSQL. Её настройка, мониторинг и балансировка нагрузки между сегментами требуют высокой квалификации DBA. Ошибки в конфигурации (например, skew данных) могут привести к падению производительности на порядки.
Ограничения в облаке и на российских платформах: В Yandex Cloud, например, для Greenplum действуют ограничения: внешние источники доступны только для чтения через SELECT, а количество временных файлов в запросе жёстко лимитировано.
2) Проблемы с расширениями: Не все PostgreSQL-расширения работают в Greenplum из-за особенностей MPP-архитектуры.
3) Лицензионная неопределённость: Greenplum долгое время был open-source, но в 2024 году Broadcom (владелец VMware Tanzu) закрыл исходный код, заархивировал репозиторий на GitHub и перевёл продукт в полностью коммерческую модель. Это создаёт серьёзные риски:
невозможность самостоятельной доработки;
зависимость от вендора в части исправления багов и уязвимостей;
потенциальный рост стоимости лицензий.
4) Ограниченная локальная поддержка: После ухода VMware и закрытия кода экосистема Greenplum в РФ начала фрагментироваться. Появились форки (например, Greengage), но они не имеют enterprise-поддержки и могут не соответствовать требованиям ЦБ РФ.
5) Сложности с обновлениями: Из-за привязки к версии PostgreSQL (Greenplum 6/7 ≈ PostgreSQL 12), переход на новые версии с исправлениями безопасности может быть затруднён.

https://clickhouse.com/ - официальный сайт ClickHouse
https://habr.com/ru/articles/797361/ - сравнение ClickHouse и Greenplum
https://habr.com/ru/companies/otus/articles/773174/ - рассказ от OTUS о ClickHouse
https://selectel.ru/blog/big-data-storage/ - сравнение ClickHouse и Greenplum для хранения больших данных
https://selectel.ru/blog/timescaledb-vs-world/ - интересные мысли о диллеме выбора СУБД, сравнение эффективности работы расширения для работы с временными рядами TimescaleDB и ClickHouse, разобраны минусы ClickHouse в работе с таким типом данных
https://bigdataschool.ru/blog/greenplum-memory-configuration/ - как работает память в Greenplum
